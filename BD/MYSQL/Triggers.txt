DELIMITER $

CREATE TRIGGER Tgr_Compra_ReajusteQntdProd AFTER INSERT
ON compras
FOR EACH ROW
BEGIN
	UPDATE produto SET qntd_disponivel = qntd_disponivel - NEW.qntd_comprada
WHERE codigo = NEW.produto_fk;
END$

DELIMITER $



DELIMITER $
CREATE TRIGGER Tgr_Compra_ReajusteQntdVendas AFTER INSERT
ON compras
FOR EACH ROW
BEGIN
	UPDATE produto SET num_vendas = num_vendas + 1
WHERE codigo = NEW.produto_fk;
	UPDATE cliente SET num_vendas = num_vendas + 1
WHERE cpf = (SELECT produtor_fk FROM produto WHERE codigo = NEW.produto_fk);
END $


DROP TRIGGER Tgr_Compra_VerificarComprador;

DELIMITER $$

CREATE TRIGGER Tgr_Compra_VerificarComprador BEFORE INSERT ON compras 
FOR EACH ROW
BEGIN
		DECLARE cpf_produtor VARCHAR(20);
        SET cpf_produtor := (SELECT produtor_fk FROM produto WHERE codigo = NEW.produto_fk);
        IF NEW.cliente_fk != cpf_produtor THEN
        	INSERT INTO compras(cliente_fk, produto_fk, qntd_comprada) VALUES(NEW.cliente_fk, NEW.produto_fk, NEW.qntd_comprada);
    	END IF;
END$$



